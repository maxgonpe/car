{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% block content %}
<div class="container py-4">
  <h2>Ingreso de Diagnóstico</h2>

  <form method="post" novalidate>
    {% csrf_token %}

    <!-- ---------------- CLIENTE ---------------- -->
    <h3>Cliente</h3>

    <div class="mb-3">
      <label class="form-label">Elegir cliente existente:</label>
      <select id="cliente_existente" name="cliente_existente" class="form-select">
        <option value="">-- Nuevo cliente --</option>
        {% for cliente in clientes_existentes %}
          <option value="{{ cliente.id }}"
            {% if selected_cliente and selected_cliente|stringformat:"s" == cliente.id|stringformat:"s" %} selected {% endif %}>
            {{ cliente.nombre }} - {{ cliente.telefono }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div id="nuevo_cliente_campos">
      {% if cliente_form.non_field_errors %}
        <div class="alert alert-danger">
          {{ cliente_form.non_field_errors }}
        </div>
      {% endif %}
      {{ cliente_form|crispy }}
    </div>

    <hr>

    <!-- ---------------- VEHÍCULO ---------------- -->
    <h3>Vehículo</h3>

    <div class="mb-3">
      <label class="form-label">Seleccionar vehículo existente:</label>
      <select
        id="vehiculo_select"
        name="vehiculo_existente"
        class="form-select"
        data-selected="{{ selected_vehiculo|default:'' }}"
      >
        <option value="">-- Nuevo vehículo --</option>
        {# El JS poblará este select al elegir cliente #}
        {% for veh in vehiculos_existentes %}
          <option value="{{ veh.id }}"
            {% if selected_vehiculo and selected_vehiculo|stringformat:"s" == veh.id|stringformat:"s" %} selected {% endif %}>
            {{ veh.placa }} • {{ veh.marca }} {{ veh.modelo }} ({{ veh.anio }})
          </option>
        {% endfor %}
      </select>
    </div>

    <div id="vehiculo_fields">
      {% if vehiculo_form.non_field_errors %}
        <div class="alert alert-danger">
          {{ vehiculo_form.non_field_errors }}
        </div>
      {% endif %}
      {{ vehiculo_form|crispy }}
    </div>

    <hr>

    <!-- ---------------- DIAGNÓSTICO ---------------- -->
    <h3>Diagnóstico</h3>

    <div class="mb-3">
      <label class="form-label">Seleccionar uno o más componentes:</label>
      {% include 'car/componentes_acordeon.html' with componentes=componentes selected_componentes_ids=selected_componentes_ids %}
    </div>

    <div class="mb-3">
      <label class="form-label">Descripción del problema:</label>
      {{ diagnostico_form|crispy }}
    </div>

    <button type="submit" class="btn btn-primary">Guardar</button>
    <a href="{% url 'panel_principal' %}" class="btn btn-sm btn-warning">Regresar</a>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const clienteSelect  = document.getElementById('cliente_existente');
  const nuevoClienteCampos = document.getElementById('nuevo_cliente_campos');

  const vehiculoSelect = document.getElementById('vehiculo_select');
  const vehiculoFields = document.getElementById('vehiculo_fields');

  function toggleClienteCampos() {
    nuevoClienteCampos.style.display = clienteSelect.value ? 'none' : 'block';
  }

  function toggleVehiculoCampos() {
    // Si hay vehículo elegido => oculto campos de "nuevo vehículo"
    // Si NO hay vehículo (valor vacío) => muestro campos para crear uno
    vehiculoFields.style.display = vehiculoSelect.value ? 'none' : 'block';
  }

  async function loadVehiculos(clienteId, selectedVehiculoId = null) {
    // Dejar placeholder
    vehiculoSelect.innerHTML = '<option value="">-- Nuevo vehículo --</option>';

    if (!clienteId) {
      toggleVehiculoCampos();
      return;
    }
    try {
      const res = await fetch(`/api/vehiculos/${clienteId}/`, {
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const data = await res.json();

      data.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v.id;
        opt.textContent = `${v.placa} • ${v.marca} ${v.modelo} (${v.anio})`;
        if (selectedVehiculoId && String(v.id) === String(selectedVehiculoId)) {
          opt.selected = true;
        }
        vehiculoSelect.appendChild(opt);
      });

      toggleVehiculoCampos();
    } catch (err) {
      console.error('Error cargando vehículos:', err);
    }
  }

  // Eventos
  clienteSelect.addEventListener('change', () => {
    toggleClienteCampos();
    // recargar lista de vehículos según el cliente
    loadVehiculos(clienteSelect.value);
    // al cambiar cliente, limpia selección de vehículo (si la había)
    vehiculoSelect.value = '';
    toggleVehiculoCampos();
  });

  vehiculoSelect.addEventListener('change', toggleVehiculoCampos);

  // Inicialización
  toggleClienteCampos();
  toggleVehiculoCampos();

  // Si ya hay un cliente seleccionado (p. ej. tras POST con errores),
  // poblamos su lista de vehículos y re-seleccionamos el que venía.
  const preSelectedVehiculoId = vehiculoSelect.dataset.selected || '';
  if (clienteSelect.value) {
    loadVehiculos(clienteSelect.value, preSelectedVehiculoId);
  }
});
</script>
{% endblock %}
