{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% block content %}

<div class="container py-4">
  <h2>Ingreso de Diagn√≥stico</h2>

  <form method="post" novalidate>
    {% csrf_token %}

    <!-- ---------------- CLIENTE ---------------- -->
    <h3>Cliente</h3>
    <div class="mb-3">
      <label class="form-label">Elegir cliente existente:</label>
      <select id="cliente_existente" name="cliente_existente" class="form-select">
        <option value="">-- Nuevo cliente --</option>
        {% for cliente in clientes_existentes %}
          <option value="{{ cliente.id }}"
            {% if selected_cliente and selected_cliente|stringformat:"s" == cliente.id|stringformat:"s" %} selected {% endif %}>
            {{ cliente.nombre }} - {{ cliente.telefono }}
          </option>
        {% endfor %}
      </select>
    </div>
    <div id="nuevo_cliente_campos">
      {{ cliente_form|crispy }}
    </div>
    <hr>

    <!-- ---------------- VEH√çCULO ---------------- -->
    <h3>Veh√≠culo</h3>
    <div class="mb-3">
      <label class="form-label">Seleccionar veh√≠culo existente:</label>
      <select id="vehiculo_select" name="vehiculo_existente" class="form-select" data-selected="{{ selected_vehiculo|default:'' }}">
        <option value="">-- Nuevo veh√≠culo --</option>
      </select>
    </div>
    <div id="vehiculo_fields">
      {{ vehiculo_form|crispy }}
    </div>
    <hr>

    <!-- ---------------- DIAGN√ìSTICO ---------------- -->
    <h3>Diagn√≥stico</h3>
    <div class="row">
      <!-- Columna izquierda: acorde√≥n -->
      <div class="col-md-6 border-end">
        <h5>Seleccionar por lista</h5>
        {% include 'car/componentes_acordeon.html' with componentes=componentes selected_componentes_ids=selected_componentes_ids %}
      </div>

      <!-- Columna derecha: plano SVG -->
      <div class="col-md-6">
        <h5>Seleccionar en el plano</h5>
        <button id="btn-reset-plano" type="button" class="btn btn-sm btn-outline-secondary mb-2">
          ‚¨ÖÔ∏è Volver al plano inicial
        </button>
        <div id="plano-container" 
             style="border:1px solid #ccc; max-height:100%; overflow:auto;"
             data-inicial-url="{% static 'images/vehiculo-desde-abajo.svg' %}">
          <div style="transform:scale(0.9); transform-origin: top left;">
            {{ svg|safe }}
          </div>
        </div>

        <!-- üîΩ Lista de componentes elegidos -->
        <div id="componentes-seleccionados" class="mt-3">
          <h6>Componentes seleccionados:</h6>
          <ul id="lista-seleccionados" class="list-group small"></ul>
        </div>
      </div>
    </div>

    <div class="mt-3">
      <label class="form-label">Descripci√≥n del problema:</label>
      {{ diagnostico_form|crispy }}
    </div>

    <button type="submit" class="btn btn-primary">Guardar</button>
    <a href="{% url 'panel_principal' %}" class="btn btn-sm btn-warning">Regresar</a>
  </form>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  // ---------------- CLIENTE ----------------
  const clienteSelect  = document.getElementById('cliente_existente');
  const nuevoClienteCampos = document.getElementById('nuevo_cliente_campos');

  function toggleClienteCampos() {
    if (!nuevoClienteCampos) return;
    nuevoClienteCampos.style.display = clienteSelect && clienteSelect.value ? 'none' : 'block';
  }

  // ---------------- VEH√çCULO ----------------
  const vehiculoSelect = document.getElementById('vehiculo_select');
  const vehiculoFields = document.getElementById('vehiculo_fields');

  function toggleVehiculoCampos() {
    vehiculoFields.style.display = vehiculoSelect.value ? 'none' : 'block';
  }

  async function cargarVehiculos(clienteId, selectedVehiculoId = null) {
    vehiculoSelect.innerHTML = '<option value="">-- Nuevo veh√≠culo --</option>';
    if (!clienteId) { toggleVehiculoCampos(); return; }
    const res = await fetch(`/api/vehiculos/${clienteId}/`);
    const data = await res.json();
    data.forEach(v => {
      const opt = document.createElement('option');
      opt.value = v.id;
      opt.textContent = `${v.placa} ‚Ä¢ ${v.marca} ${v.modelo} (${v.anio})`;
      if (selectedVehiculoId && String(v.id) === String(selectedVehiculoId)) {
        opt.selected = true;
      }
      vehiculoSelect.appendChild(opt);
    });
    toggleVehiculoCampos();
  }

  // Eventos cliente
  if (clienteSelect) {
    clienteSelect.addEventListener('change', () => {
      toggleClienteCampos();
      cargarVehiculos(clienteSelect.value);
      vehiculoSelect.value = '';
      toggleVehiculoCampos();
    });
    toggleClienteCampos();
  }

  // Eventos veh√≠culo
  if (vehiculoSelect) {
    vehiculoSelect.addEventListener('change', toggleVehiculoCampos);
    if (clienteSelect && clienteSelect.value) {
      cargarVehiculos(clienteSelect.value, vehiculoSelect.dataset.selected);
    } else {
      toggleVehiculoCampos();
    }
  }

  // ---------------- COMPONENTES SELECCIONADOS ----------------
  const listaSeleccionados = document.getElementById("lista-seleccionados");

  function actualizarListaSeleccionados() {
    listaSeleccionados.innerHTML = "";
    document.querySelectorAll('input[name="componentes_seleccionados"]:checked').forEach(cb => {
      const li = document.createElement("li");
      li.className = "list-group-item py-1";
      li.textContent = cb.dataset.nombre || `ID ${cb.value}`;
      listaSeleccionados.appendChild(li);
    });
  }

  // Escuchar cambios en acorde√≥n
  document.querySelectorAll('input[name="componentes_seleccionados"]').forEach(cb => {
    cb.addEventListener("change", actualizarListaSeleccionados);
  });
  actualizarListaSeleccionados();

  // ---------------- BOT√ìN RESET PLANO ----------------
  const btnResetPlano = document.getElementById("btn-reset-plano");
  btnResetPlano?.addEventListener("click", () => {
    const cont = document.getElementById("plano-container");
    const url = cont.dataset.inicialUrl;
    cont.innerHTML = `<object type="image/svg+xml" data="${url}" class="w-100"></object>`;
  });

  


  
});
</script>

{% endblock %}
